<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Agent Map Viewer</title>
    <style>
      html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #0e0f10; }
      #app { width: 100%; height: 100%; }

      /* Global UI */
      .ui { position: absolute; pointer-events: none; inset: 0; }
      .panel { pointer-events: auto; backdrop-filter: blur(4px); background: rgba(18,19,20,0.75); border: 1px solid rgba(255,255,255,0.12); color: #e6e7e8; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.45); }
      .toolbar { position: absolute; top: 16px; left: 16px; display: flex; gap: 8px; align-items: center; padding: 8px; z-index: 12; }
      .toolbar .btn { width: 36px; height: 36px; display: grid; place-items: center; background: #1a1c1f; border: 1px solid rgba(255,255,255,0.08); color: #e6e7e8; border-radius: 8px; cursor: pointer; transition: background 120ms ease, transform 80ms ease; }
      .toolbar .btn:hover { background: #22252a; }
      .toolbar .btn:active { transform: translateY(1px); }
      .toolbar .btn.active { background: #2563eb; border-color: #3b82f6; color: #ffffff; }
      .toolbar .label { padding: 0 8px; opacity: 0.8; font-size: 12px; }

      /* Search */
      .search { position: relative; display: flex; align-items: center; }
      #searchBox { width: 260px; height: 36px; box-sizing: border-box; padding: 0 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); background: #1a1c1f; color: #e6e7e8; outline: none; font-size: 13px; }
      #searchBox::placeholder { color: #9aa3af; }
      #searchResults { position: absolute; top: 40px; left: 0; width: 320px; max-height: 260px; overflow: auto; background: rgba(17,18,20,0.92); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; box-shadow: 0 10px 24px rgba(0,0,0,0.45); padding: 6px 6px; display: none; z-index: 20; }
      #searchResults .item { padding: 8px 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; }
      #searchResults .item:hover, #searchResults .item.active { background: #23262b; }
      #searchResults .pill { font-size: 11px; padding: 2px 6px; border-radius: 999px; background: #2b2f36; color: #bfc6d1; }

      .legend { position: absolute; top: 16px; right: 16px; padding: 0; width: 248px; overflow: hidden; }
      .legend header { display:flex; align-items:center; justify-content:space-between; padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.08); }
      .legend h3 { margin: 0; font-size: 13px; letter-spacing: 0.4px; opacity: 0.9; }
      .legend .actions { display:flex; gap:8px; }
      .legend .actions .mini { font-size:11px; padding:4px 6px; border-radius:6px; background:#1a1c1f; border:1px solid rgba(255,255,255,0.08); cursor:pointer; color:#cbd5e1; }
      .legend .body { padding: 8px 10px; display:grid; grid-template-columns: 1fr; gap: 4px; max-height: 420px; overflow:auto; }
      .legend .row { display: flex; align-items: center; gap: 10px; padding: 6px 8px; border-radius: 8px; transition: background 120ms ease, transform 60ms ease; }
      .legend .row:hover { background: #23262b; }
      .legend .row:active { transform: translateY(1px); }
      .swatch { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.25); box-shadow: 0 0 0 2px rgba(0,0,0,0.15) inset; }
      .legend label { display:flex; align-items:center; gap:8px; font-size: 13px; flex: 1; }
      .legend input[type="checkbox"] { width: 16px; height: 16px; margin: 0; border-radius: 4px; background: #1a1c1f; border: 1px solid rgba(255,255,255,0.1); }
      .legend .hint { font-size: 11px; opacity: 0.65; padding: 8px 12px 10px; border-top: 1px solid rgba(255,255,255,0.08); }

      /* Old fixed HUD (kept but hidden; replaced by floating agent HUD) */
      .hud { display:none; }
      /* Floating agent HUD */
      .agentHUD { position:absolute; min-width: 280px; max-width: 340px; padding: 10px 12px; font-size: 12px; pointer-events:none; }
      .agentHUD .row { display:flex; align-items:center; justify-content:space-between; gap:10px; margin: 6px 0; }
      .agentHUD .badge { font-size: 11px; padding: 3px 8px; border-radius: 999px; background: #1a1c1f; border: 1px solid rgba(255,255,255,0.08); color:#cbd5e1; }
      .agentHUD .title { font-weight: 600; letter-spacing: 0.2px; }
      .agentHUD .muted { opacity: 0.8; }
      .agentHUD .bar { height: 6px; flex:1; background: #141518; border-radius: 999px; overflow: hidden; border: 1px solid rgba(255,255,255,0.06); }
      .agentHUD .fill { height: 100%; background: linear-gradient(90deg,#60a5fa,#34d399); }
      .agentHUD .mono { color: #9ccaff; }

      /* Docked HUD under the scale bar */
      #agentHUDDock { position:absolute; left:16px; bottom:16px; width:320px; pointer-events:none; z-index:4; }
      #agentHUDDock .agentHUD { position:relative; width:100%; }
      .hud .row { display:flex; align-items:center; justify-content:space-between; gap:10px; margin: 6px 0; }
      .hud .badge { font-size: 11px; padding: 3px 8px; border-radius: 999px; background: #1a1c1f; border: 1px solid rgba(255,255,255,0.08); color:#cbd5e1; }
      .hud .title { font-weight: 600; letter-spacing: 0.2px; }
      .hud .muted { opacity: 0.8; }
      .hud .bar { height: 6px; flex:1; background: #141518; border-radius: 999px; overflow: hidden; border: 1px solid rgba(255,255,255,0.06); }
      .hud .fill { height: 100%; background: linear-gradient(90deg,#60a5fa,#34d399); }
      .hud .mono { color: #9ccaff; }

      /* Minimap */
      .minimap { position: absolute; right: 16px; bottom: 16px; padding: 8px; display: grid; gap: 8px; z-index: 6; }
      #minimapCanvas { width: 200px; height: 200px; image-rendering: crisp-edges; image-rendering: pixelated; background: #0b0c0d; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); }
      .minimap .caption { text-align: center; font-size: 11px; opacity: 0.7; }

      /* Scale bar */
      .scalebar { position: absolute; left: 16px; bottom: 96px; padding: 6px 8px; display: inline-flex; align-items: center; gap: 8px; z-index:5; pointer-events:none; }
      .scale-track { height: 6px; background: linear-gradient(90deg, #6b7280, #cbd5e1); border-radius: 4px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.4); }
      .scale-label { font-size: 12px; opacity: 0.85; }

      .btn, label { user-select: none; }

      /* Metrics + Feed right panel */
      .rightPanel { position:absolute; right:16px; bottom:260px; display:grid; gap:8px; width: 300px; max-height:calc(100vh - 320px); overflow-y:auto; z-index:5; }
      .metrics { padding:8px 10px; }
      .metrics .row { display:flex; align-items:center; justify-content:space-between; margin:4px 0; }
      .metrics .k { opacity:0.8; font-size:11px; }
      .metrics .v { font-variant-numeric: tabular-nums; color:#cfe1ff; font-size:12px; }
      .thoughts { max-height: 140px; }
      .feed .item { margin:6px 0; padding:6px 8px; border-radius:6px; background:#17191d; border:1px solid rgba(255,255,255,0.06); }
      .feed .who { font-size:11px; opacity:0.8; margin-bottom:3px; color:#93c5fd; }
      .feed .chat { white-space:pre-wrap; font-size:11px; line-height:1.3; }
      .feed .decision { white-space:pre-wrap; font-size:11px; line-height:1.3; font-style:italic; opacity:0.9; }

      /* Scenario toolbar (separate row, left-aligned, compact width) */
      /* .scenarioBar { position:absolute; top: 76px; left: 16px; display:flex; gap:10px; align-items:center; padding:8px; max-width: 720px; width: max-content; background: rgba(37,99,235,0.15); border:1px solid, rgba(255,255,255,0.08); z-index:11; }
      .scenarioBar .label { color:#60a5fa; font-weight:600; }
      .scenarioBar select { background:#0f1114; border:1px solid #334155; color:#e6e7e8; border-radius:8px; padding:6px 10px; font-size:12px; }
      .scenarioBar .btn-primary { font-size:12px; padding:6px 12px; border-radius:8px; background:#3b82f6; border:1px solid #2563eb; cursor:pointer; color:white; font-weight: 600; }
      .scenarioBar .btn-muted { font-size:12px; padding:6px 12px; border-radius:8px; background:#1a1c1f; border:1px solid #334155; cursor:pointer; color:#cbd5e1; font-weight: 600; } */
      /* Scenario toolbar — polished + consistent with .panel */
.scenarioBar {
  position: absolute;
  top: 76px;
  left: 16px;
  display: flex;
  gap: 10px;
  align-items: center;
  padding: 8px 10px;
  max-width: 760px;
  width: max-content;

  /* match panel look */
  background: rgba(18,19,20,0.85);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.45);
  z-index: 14; /* above toolbar */
}

.scenarioBar::before {
  /* subtle accent strip to improve visibility */
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 10px;
  box-shadow: 0 0 0 1px rgba(59,130,246,0.18) inset;
  pointer-events: none;
}

.scenarioBar .label {
  color: #93c5fd;           /* same blue family as elsewhere */
  font-weight: 600;
  letter-spacing: 0.2px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

/* Controls look & feel (unify with other bars) */
.scenarioBar select {
  height: 34px;
  background: #0f1114;
  color: #e6e7e8;
  border: 1px solid #334155;
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 12px;
  outline: none;
  transition: border-color 120ms ease, background 120ms ease;
}
.scenarioBar select:hover { background:#13161a; }
.scenarioBar select:focus { border-color:#60a5fa; }

/* Primary + muted buttons consistent with .toolbar buttons */
.scenarioBar .btn-primary,
.scenarioBar .btn-muted {
  height: 34px;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid rgba(255,255,255,0.10);
  background: #1a1c1f;
  color: #cbd5e1;
  transition: transform 80ms ease, background 120ms ease, border-color 120ms ease;
}
.scenarioBar .btn-primary {
  background: #2563eb;
  border-color: #3b82f6;
  color: #ffffff;
}
.scenarioBar .btn-muted:hover { background:#22252a; }
.scenarioBar .btn-primary:hover { background:#1e50c7; }
.scenarioBar .btn-primary:active,
.scenarioBar .btn-muted:active { transform: translateY(1px); }

/* Status capsule */
#scenarioStatus {
  height: 28px;
  display: inline-grid;
  place-items: center;
  padding: 0 10px;
  border-radius: 999px;
  background:#0f1114;
  color:#cbd5e1;
  border: 1px solid #334155;
  font-size: 11px;
  letter-spacing: 0.2px;
}

/* Optional status color helpers you can toggle via JS */
#scenarioStatus.is-ready   { border-color:#1f6feb; color:#9ccaff; }
#scenarioStatus.is-busy    { border-color:#f59e0b; color:#fde68a; }
#scenarioStatus.is-error   { border-color:#ef4444; color:#fecaca; }

/* Compact layout on narrow widths */
@media (max-width: 1100px) {
  .scenarioBar { flex-wrap: wrap; gap: 8px; }
  .scenarioBar .label { width: 100%; }
}

      /* Collapsible panels */
      .panel.collapsible header { cursor: pointer; }
      .panel.collapsible .collapseToggle { font-size:11px; padding:4px 6px; border-radius:6px; background:#1a1c1f; border:1px solid rgba(255,255,255,0.08); cursor:pointer; color:#cbd5e1; transform: rotate(0deg); transition: transform 120ms ease; }
      .panel.collapsible.collapsed .body { display: none; }
      .panel.collapsible.collapsed .collapseToggle { transform: rotate(-90deg); }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <div class="ui">
      <div class="toolbar panel">
        <div class="btn" id="btnZoomIn" title="Zoom in">+</div>
        <div class="btn" id="btnZoomOut" title="Zoom out">−</div>
        <div class="btn" id="btnCenter" title="Center on POI">◎</div>
        <div class="btn" id="btnFit" title="Fit whole map">▢</div>
        <div class="label">Zoom: <code id="hudZoom">—</code> | Grid: <code id="hudTiles">—</code></div>
        <div class="search">
          <input id="searchBox" type="text" placeholder="Search buildings, POIs… (Enter to confirm)" />
          <div id="searchResults"></div>
        </div>
        <div class="label" style="margin-left:12px;">Speed:</div>
        <div class="btn" id="speed1" title="1x">1×</div>
        <div class="btn" id="speed2" title="2x">2×</div>
        <div class="btn" id="speed4" title="4x">4×</div>
        <div class="btn" id="speed100" title="100x">100×</div>
        <div class="label" style="margin-left:12px;">Overlays:</div>
        <div class="btn" id="btnIntents" title="Toggle intent chips">INT</div>
      </div>

      <!-- Separate scenario toolbar for better visibility -->
      <div class="scenarioBar panel">
        <div class="label"> Hypothesis:</div>
        <select id="scenarioSelect">
          <option value="baseline">📍 Baseline (Original)</option>
          <option value="h001">🏪 H001 - Convenience+Pharmacy+Cafe</option>
          <option value="h003">🍽️ H002 - Market Square</option>
        </select>
        <button id="btnLoadScenario" class="btn-primary">Load</button>
        <button id="btnToggleBaseline" class="btn-muted">Show All</button>
        <div id="scenarioStatus" style="font-size:11px; padding:4px 8px; border-radius:6px; background:#0f1114; color:#cbd5e1; border:1px solid #334155;">Ready</div>
      </div>

      <div class="legend panel">
        <header>
          <h3>Points of Interest</h3>
          <div class="actions"><button id="fltAll" class="mini">All</button><button id="fltNone" class="mini">None</button></div>
        </header>
        <div class="body">
          <div class="row"><span class="swatch" style="background:#22C55E"></span><label><input type="checkbox" id="fltGrocery" checked style="accent-color:#22C55E" /> Grocery</label></div>
          <div class="row"><span class="swatch" style="background:#F472B6"></span><label><input type="checkbox" id="fltPharmacy" checked style="accent-color:#F472B6" /> Pharmacy</label></div>
          <div class="row"><span class="swatch" style="background:#F59E0B"></span><label><input type="checkbox" id="fltCafe" checked style="accent-color:#F59E0B" /> Cafe</label></div>
          <div class="row"><span class="swatch" style="background:#BB6BD9"></span><label><input type="checkbox" id="fltRestaurant" checked style="accent-color:#BB6BD9" /> Restaurant</label></div>
          <div class="row"><span class="swatch" style="background:#0EA5E9"></span><label><input type="checkbox" id="fltTransit" checked style="accent-color:#0EA5E9" /> Transit</label></div>
          <div class="row"><span class="swatch" style="background:#6366F1"></span><label><input type="checkbox" id="fltEducation" checked style="accent-color:#6366F1" /> Education</label></div>
          <div class="row"><span class="swatch" style="background:#EF4444"></span><label><input type="checkbox" id="fltHealth" checked style="accent-color:#EF4444" /> Health</label></div>
          <div class="row"><span class="swatch" style="background:#06B6D4"></span><label><input type="checkbox" id="fltRetail" checked style="accent-color:#06B6D4" /> Retail</label></div>
          <div class="row"><span class="swatch" style="background:#94A3B8"></span><label><input type="checkbox" id="fltOther" checked style="accent-color:#94A3B8" /> Other</label></div>
        </div>
        <div class="hint">Toggle categories to dim markers rather than hide them.</div>
      </div>

      <div class="hud panel">
        Wheel to zoom, drag to pan
      </div>

      <div class="minimap panel">
        <canvas id="minimapCanvas" width="200" height="200"></canvas>
        <div class="caption">Minimap</div>
      </div>

      <div class="scalebar panel">
        <div id="scaleTrack" class="scale-track" style="width: 120px"></div>
        <div id="scaleLabel" class="scale-label">100 m</div>
      </div>

      <!-- Docked HUD container (below the scale bar) -->
      <div id="agentHUDDock"></div>

      <!-- Right side: Metrics + Thoughts + Society feed -->
      <div class="rightPanel">
        <div class="panel collapsible" id="metricsPanel">
          <header style="display:flex; align-items:center; justify-content:space-between; padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.08);">
            <h3 style="margin:0; font-size:13px; letter-spacing:0.4px; opacity:0.9;">Metrics</h3>
            <button class="mini collapseToggle">▾</button>
          </header>
          <div class="body metrics">
            <div class="row"><div class="k">Trips</div><div class="v" id="mTrips">0</div></div>
            <div class="row"><div class="k">Avg time</div><div class="v" id="mAvgTime">—</div></div>
            <div class="row"><div class="k">Avg distance</div><div class="v" id="mAvgDist">—</div></div>
            <div class="row"><div class="k">By category</div><div class="v" id="mByCat">—</div></div>
          </div>
        </div>
        
        <div class="panel collapsible" id="scenarioPanel">
          <header style="display:flex; align-items:center; justify-content:space-between; padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.08);">
            <h3 style="margin:0; font-size:13px; letter-spacing:0.4px; opacity:0.9;">Scenario Changes</h3>
            <div style="display:flex; gap:6px; align-items:center;">
              <button id="btnZoomScenario" class="mini" style="font-size:11px; padding:4px 6px; border-radius:6px; background:#1a1c1f; border:1px solid rgba(255,255,255,0.08); cursor:pointer; color:#cbd5e1;">Zoom</button>
              <button class="mini collapseToggle">▾</button>
            </div>
          </header>
          <div class="body" style="padding:8px 10px; font-size:12px; opacity:0.9;">
            <div id="scenarioSummary">No scenario active.</div>
            <div id="scenarioPanelBody" style="margin-top:6px; max-height:120px; overflow-y:auto;"></div>
          </div>
        </div>
        
        <div class="thoughts panel collapsible" id="thoughtsPanel">
          <header style="display:flex; align-items:center; justify-content:space-between; padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.08);">
            <h3 style="margin:0; font-size:13px; letter-spacing:0.4px; opacity:0.9;">Agent Thoughts</h3>
            <div style="display:flex; gap:6px; align-items:center;">
              <select id="thoughtsAgentSelect" style="background:#1a1c1f; border:1px solid rgba(255,255,255,0.08); color:#e6e7e8; border-radius:6px; padding:4px 8px; font-size:11px;">
                <option value="">Select agent...</option>
              </select>
              <button class="mini collapseToggle">▾</button>
            </div>
          </header>
          <div id="thoughtsContent" class="body" style="padding:10px 12px; max-height:120px; overflow-y:auto; font-size:12px; line-height:1.4;">
            <div style="opacity:0.6; font-style:italic;">Select an agent to view their thoughts</div>
          </div>
        </div>
        
        <div class="feed panel collapsible" id="feedPanel">
          <header style="display:flex; align-items:center; justify-content:space-between; padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.08);">
            <h3 style="margin:0; font-size:13px; letter-spacing:0.4px; opacity:0.9;">Society Feed</h3>
            <div style="display:flex; gap:6px;">
              <button id="feedFilterAll" class="mini" style="font-size:11px; padding:4px 6px; border-radius:6px; background:#1a1c1f; border:1px solid rgba(255,255,255,0.08); cursor:pointer; color:#cbd5e1;">All</button>
              <button id="feedFilterChats" class="mini" style="font-size:11px; padding:4px 6px; border-radius:6px; background:#1a1c1f; border:1px solid rgba(255,255,255,0.08); cursor:pointer; color:#cbd5e1;">Chats</button>
              <button id="feedFilterDecisions" class="mini" style="font-size:11px; padding:4px 6px; border-radius:6px; background:#1a1c1f; border:1px solid rgba(255,255,255,0.08); cursor:pointer; color:#cbd5e1;">Decisions</button>
              <button class="mini collapseToggle">▾</button>
            </div>
          </header>
          <div id="societyFeed" class="body" style="max-height:180px; overflow-y:auto; padding:10px 12px;"></div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.4.0/dist/pixi.min.js"></script>
    <script src="orchestrator.js"></script>
    <script src="viewer.js"></script>
  </body>
</html>
